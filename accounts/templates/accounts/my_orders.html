{% extends "shop/base/base.html" %}
{% load static %}

{% block title %}Mis pedidos{% endblock %}

{% block content %}
<div class="bg-light py-3">
    <div class="container">
        <div class="row">
            <div class="col-md-12 mb-0">
                <a href="{% url 'accounts:profile' %}">Mi perfil</a>
                <span class="mx-2 mb-0">/</span>
                <strong class="text-black">Mis pedidos</strong>
            </div>
        </div>
    </div>
</div>

<div class="site-section">
    <div class="container">
        <h2 class="mb-4">Mis Pedidos</h2>

        {% if orders %}
            {% for order in orders %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light" style="cursor: pointer;" data-toggle="collapse" data-target="#order-{{ order.id }}" aria-expanded="false" aria-controls="order-{{ order.id }}">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">Pedido #{{ order.order_number }}</h5>
                            <small class="text-muted">{{ order.created|default:"Fecha no disponible" }}</small>
                        </div>
                        <div class="col-md-6 text-md-right">
                            <span class="badge 
                                {% if order.status == 'delivered' %}badge-success
                                {% elif order.status == 'shipped' %}badge-info
                                {% elif order.status == 'processing' %}badge-warning
                                {% elif order.status == 'cancelled' %}badge-danger
                                {% elif order.status == 'paid' %}badge-success
                                {% else %}badge-secondary
                                {% endif %} p-2">
                                {% if order.status == 'pending' %}PENDIENTE
                                {% elif order.status == 'paid' %}PAGADO
                                {% elif order.status == 'processing' %}EN PROCESO
                                {% elif order.status == 'shipped' %}ENVIADO
                                {% elif order.status == 'delivered' %}ENTREGADO
                                {% elif order.status == 'cancelled' %}CANCELADO
                                {% else %}{{ order.status|upper }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                <div id="order-{{ order.id }}" class="collapse">
                    <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="font-weight-bold mb-3">Artículos:</h6>
                            {% for item in order.items %}
                            <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                                <div>
                                    <strong>{{ item.product_name }}</strong>
                                    {% if item.size %}<br><small class="text-muted">Talla: {{ item.size }}</small>{% endif %}
                                    <br><small>Cantidad: {{ item.quantity }}</small>
                                </div>
                                <strong>${{ item.price|floatformat:"2" }}</strong>
                            </div>
                            {% empty %}
                            <p class="text-muted">No hay artículos disponibles</p>
                            {% endfor %}
                        </div>
                        <div class="col-md-4">
                            <h6 class="font-weight-bold mb-3">Resumen:</h6>
                            <div class="mb-2">
                                <small>Subtotal:</small>
                                <strong class="float-right">${{ order.subtotal|floatformat:"2" }}</strong>
                            </div>
                            <div class="mb-2">
                                <small>Envío:</small>
                                <strong class="float-right">${{ order.shipping_cost|floatformat:"2" }}</strong>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <strong>Total:</strong>
                                <strong class="float-right" style="font-size: 1.2em;">${{ order.total|floatformat:"2" }}</strong>
                            </div>
                            <div class="mb-2">
                                <small>Estado de pago:</small>
                                <strong class="float-right">
                                    {% if order.paid %}
                                        <span class="text-success">✓ Pagado</span>
                                    {% else %}
                                        <span class="text-warning">Pendiente</span>
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="mb-2">
                                <small>Método de pago:</small>
                                <strong class="float-right">
                                    {% if order.payment_method == 'card' %}
                                        Tarjeta
                                    {% elif order.payment_method == 'cod' %}
                                        Contrareembolso
                                    {% else %}
                                        {{ order.payment_method }}
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="font-weight-bold">Información de envío:</h6>
                            <p class="mb-1"><small>{{ order.first_name }} {{ order.last_name }}</small></p>
                            <p class="mb-1"><small>{{ order.address }}</small></p>
                            <p class="mb-1"><small>{{ order.city }}, {{ order.postal_code }}</small></p>
                            <p class="mb-0"><small>{{ order.email }}</small></p>
                        </div>
                        <div class="col-md-6 text-md-right">
                            <h6 class="font-weight-bold">Seguimiento:</h6>
                            <div class="mt-2">
                                {% if order.status == 'pending' %}
                                    <small class="text-muted">Tu pedido está siendo procesado</small>
                                {% elif order.status == 'paid' %}
                                    <small class="text-success">Pago confirmado, preparando envío</small>
                                {% elif order.status == 'processing' %}
                                    <small class="text-muted">Preparando tu pedido para envío</small>
                                {% elif order.status == 'shipped' %}
                                    <small class="text-info">Tu pedido ha sido enviado</small>
                                {% elif order.status == 'delivered' %}
                                    <small class="text-success">✓ Pedido entregado</small>
                                {% elif order.status == 'cancelled' %}
                                    <small class="text-danger">Pedido cancelado</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <h5>No tienes pedidos aún</h5>
                <p class="mb-0">Cuando realices tu primera compra, aparecerá aquí.</p>
                <a href="{% url 'shop:product_list' %}" class="btn btn-primary mt-3">Ir a la tienda</a>
            </div>
        {% endif %}

        <div class="mt-4">
            <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">Volver a mi perfil</a>
        </div>
    </div>
</div>
{% endblock %}
